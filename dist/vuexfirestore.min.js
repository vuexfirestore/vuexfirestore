/*!
 * vuexfirestore v0.0.1
 * (c) 2018 
 * Released under the MIT License.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.VuexFire={})}(this,function(e){"use strict";function I(e){return Object.defineProperty(e.data(),"id",{value:e.id})}var c=function(e){return e&&"object"==typeof e},a=function(e){return e.toDate},u=function(e){return e&&e.onSnapshot};function p(r,o,i,e){void 0===i&&(i=""),void 0===e&&(e=[{},{}]),o=o||{};var t=Object.getOwnPropertyDescriptor(r,"id");return t&&!t.enumerable&&Object.defineProperty(e[0],"id",t),Object.keys(r).reduce(function(e,t){var n=r[t];return u(n)?(e[0][t]=o[t]||n.path,e[1][i+t]=n):Array.isArray(n)?(e[0][t]=Array(n.length).fill(null),p(n,o[t],i+t+".",[e[0][t],e[1]])):null==n||n instanceof Date||a(n)||n.longitude&&n.latitude?e[0][t]=n:c(n)?(e[0][t]={},p(n,o[t],i+t+".",[e[0][t],e[1]])):e[0][t]=n,e},e)}function h(e,t){return t.split(".").reduce(function(e,t){return e[t]},e)}var t,w="vuexfire/SET_VALUE",g="vuexfire/ARRAY_ADD",b="vuexfire/ARRAY_REMOVE",r=((t={})[w]=function(e,t){var n,r,o,i,c,a=t.path,u=t.target,f=t.data;n=u,r=f,o=(""+a).split("."),i=o.pop(),c=o.reduce(function(e,t){return e[t]},n),isFinite(i)?c.splice(i,1,r):c[i]=r},t[g]=function(e,t){var n=t.newIndex,r=t.data;t.target.splice(n,0,r)},t[b]=function(e,t){var n=t.oldIndex;return t.target.splice(n,1)[0]},t),l={root:!0},m=[],d={maxRefDepth:2,limit:4,orderBy:null,orderDirection:null};function v(e){var r,f=e.vm,s=e.key,t=e.collection,d=e.commit,o=e.resolve,n=e.reject,i=(t=t.limit(m[s].options.limit)).onSnapshot(function(e){var t="function"==typeof e.docChanges?e.docChanges():e.docChanges;if(!r&&t.length&&t.forEach(function(t){var e,n,r,o,i,c,a,u=m[s].refList.some(function(e){return e.id===t.doc.id});"added"!==t.type||u||(e={vm:f,key:s,docRef:t.doc.ref,commit:d},n=e.vm,r=e.key,o=e.docRef,i=e.commit,c=h(n,r),a=o.onSnapshot(function(t){var e=m[r].refList.findIndex(function(e){return e.id===t.id});if(t.exists){var n=Object.assign({},{docId:t.id},t.data());-1===e?(m[r].refList.push({id:t.id,ref:a}),i(g,{target:c,newIndex:m[r].refList.length,data:n},l)):(i(b,{target:c,oldIndex:e},l),i(g,{target:c,newIndex:e,data:n},l))}else i(b,{target:c,oldIndex:e},l),m[r].refList.splice(e,1)[0].ref()}))}),r=!0,i(),t.length){var n=t[t.length-1];m[s].nextRef=m[s].ref.startAfter(n.doc)}t.length||o()},n);return function(){i(),m[s].refList.forEach(function(e){return e.ref()})}}var o={},E={root:!0};function A(e){for(var t in e)e[t].unsub()}function y(e,v){var p=e.subs,h=e.refs,g=e.target,b=e.path,y=(e.data,e.depth),x=e.commit,j=e.resolve,t=Object.keys(h);if(Object.keys(p).filter(function(e){return t.indexOf(e)<0}).forEach(function(e){p[e].unsub(),delete p[e]}),console.log(t),!t.length||++y>v.maxRefDepth)return j(b);var k=0,R=t.length,O=Object.create(null);t.forEach(function(e){var t,n,r,o,i,c,a,u,f,s,d=p[e],l=h[e],m=b+"."+e;if(O[m]=!0,d){if(d.path===l.path)return;d.unsub()}p[e]={unsub:(t={ref:l,target:g,path:m,depth:y,commit:x,resolve:function(e){e in O&&++k>=R&&j(b)}.bind(null,m)},n=v,r=t.ref,o=t.target,i=t.path,c=t.depth,a=t.commit,u=t.resolve,f=Object.create(null),s=r.onSnapshot(function(e){e.exists?D({snapshot:I(e),target:o,path:i,subs:f,depth:c,commit:a,resolve:u},n):(a(w,{target:o,path:i,data:null},E),u(i))}),function(){s(),A(f)}),path:l.path}})}function D(e,t){var n=e.snapshot,r=e.target,o=e.path,i=e.subs,c=e.depth;void 0===c&&(c=0);var a=e.commit,u=e.resolve,f=p(n,h(r,o)),s=f[0],d=f[1];a(w,{path:o,target:r,data:s},E),y({data:s,subs:i,refs:d,target:r,path:o,depth:c,commit:a,resolve:u},t)}Object.keys(r).forEach(function(n){o[n]=function(e,t){r[n](t.state,t)}});var f=new WeakMap;function i(e,n){var r=e.state,o=e.commit,i=e.key,c=e.ref;void 0===n&&(n={maxRefDepth:2});var a=f.get(o);return a||(a=Object.create(null),f.set(o,a)),i in a&&x({commit:o,key:i}),new Promise(function(e,t){a[i]=c.where?function(e,f){var i=e.vm,c=e.key,t=e.collection,s=e.commit,d=e.resolve,n=e.reject;s(w,{path:c,target:i,data:[]},E);var a,l=h(i,c),u=d,m=[],v={added:function(e){var t=e.newIndex,n=e.doc;m.splice(t,0,Object.create(null));var r=m[t],o=p(I(n)),i=o[0],c=o[1];s(g,{target:l,newIndex:t,data:i},E),y({data:i,refs:c,subs:r,target:l,path:t,depth:0,commit:s,resolve:d.bind(null,n)},f)},modified:function(e){var t=e.oldIndex,n=e.newIndex,r=e.doc,o=m.splice(t,1)[0];m.splice(n,0,o);var i=s(b,{target:l,oldIndex:t},E),c=p(I(r),i),a=c[0],u=c[1];s(g,{target:l,newIndex:n,data:a},E),y({data:a,refs:u,subs:o,target:l,path:n,depth:0,commit:s,resolve:d},f)},removed:function(e){var t=e.oldIndex;s(b,{target:l,oldIndex:t},E),A(m.splice(t,1)[0])}},r=t.onSnapshot(function(e){var t="function"==typeof e.docChanges?e.docChanges():e.docChanges;if(!a&&t.length){a=!0;var n=0,r=t.length,o=t.reduce(function(e,t){return e[t.doc.id]=!1,e},Object.create(null));d=function(e){e.id in o&&++n>=r&&(u(i[c]),d=function(e){})}}t.forEach(function(e){v[e.type](e)}),t.length||d()},n);return function(){r(),m.forEach(A)}}({vm:r,key:i,collection:c,commit:o,resolve:e,reject:t},n):function(e,t){var n,r,o,i=e.vm,c=e.key,a=e.document,u=e.commit,f=e.resolve,s=e.reject,d=Object.create(null);n=f,r=function(){return i[c]},f=function(){if(!o)return o=!0,n(r())};var l=a.onSnapshot(function(e){e.exists?D({snapshot:I(e),target:i,path:c,subs:d,commit:u,resolve:f},t):f()},s);return function(){l(),A(d)}}({vm:r,key:i,document:c,commit:o,resolve:e,reject:t},n)})}function x(e){var t=e.commit,n=e.key,r=f.get(t);r&&(r[n](),delete r[n])}e.firebaseMutations=o,e.firebaseAction=function(n){return function(e,t){var f=e.state,s=e.commit;return e.bindFirebaseRef=function(e,t,n){return void 0===n&&(n={}),i({state:f,commit:s,key:e,ref:t},n)},e.unbindFirebaseRef=function(e){return x({commit:s,key:e})},e.bindMultipageRef=function(e,t,n){return void 0===n&&(n={}),o=n,i=(r={state:f,commit:s,key:e,ref:t}).state,c=r.commit,a=r.key,u=r.ref,void 0===o&&(o={}),o=Object.assign({},d,o),m[a]||(m[a]={ref:u,refList:[],nextRef:null,options:o}),new Promise(function(e,t){if(m[a].ref.where)return v({vm:i,key:a,collection:u,commit:c,resolve:e,reject:t},m[a].options);e()});var r,o,i,c,a,u},e.unbindMultipageRef=function(e){return function(e){e.commit;var t=e.key,n=m[t];n&&(n[t].nextRef&&n[t].nextRef(),n[t].refList.forEach(function(e){return e()}),delete n[t])}({commit:s,key:e})},e.fetchNextMultipageRef=function(e){return n=(t={state:f,commit:s,key:e}).state,r=t.commit,o=t.key,m[o].nextRef?new Promise(function(e,t){return v({vm:n,key:o,collection:m[o].nextRef,commit:r,resolve:e,reject:t})}):new Promise(function(){});var t,n,r,o},n(e,t)}},Object.defineProperty(e,"__esModule",{value:!0})});